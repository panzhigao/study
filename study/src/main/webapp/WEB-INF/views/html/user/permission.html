<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>用户中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="$!{rc.contextPath}/static/res/layui/css/layui.css">
  <link rel="stylesheet" href="$!{rc.contextPath}/static/res/css/global.css">
  <script src="$!{rc.contextPath}/static/js/jquery.js"></script>
  <link href="http://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css" rel="stylesheet">
  <script src="http://apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<body class="childrenBody" style="height:2500px;">

  <div class="fly-panel fly-panel-user" pad20>
    <div class="layui-tab layui-tab-brief" lay-filter="user"> 	
      <div class="layui-tab-content" style="padding:0;">
	    <div class="layui-tab-item layui-show">
		    <div class="layui-btn-group">
		     	<button class="layui-btn" id="add" data-toggle="modal" data-target="#myModal"><i class="layui-icon">&#xe608;</i> 增加</button>
		     	<button class="layui-btn" id="btnAdd"><i class="layui-icon">&#xe608;</i> 新增权限</button>
	  		</div>
	    </div>
      	<table class="layui-hidden" id="treeTable" lay-filter="treeTable"></table>
      </div>
    </div>
  </div>

<!-- 模态框（Modal） -->
<div  class="modal fade" style="margin-top:100px" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <input type="hidden" id="selectPId"/>
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">添加权限</h4>
            </div>
            <div class="modal-body">
            	<div class="layui-form-item">
    				
    				<div class="">
    				    <h4> 权限名称:</h4>
      					<input type="text" id="permissionName" name="permissionName"  placeholder="请输入权限名称" autocomplete="off" class="layui-input">
    				</div>
    				<div class="">
    				    <h4> 权限URL地址:</h4>
      					<input type="text" id="url" name="url"  placeholder="请输入权限URL地址" autocomplete="off" class="layui-input">
    				</div>
    				
  				</div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="addPermission">新增</button>
            </div>
            
        </div>
    </div>
</div>

<script src="$!{rc.contextPath}/static/res/layui/layui.js"></script>
<script src="$!{rc.contextPath}/static/js/util.js"></script>
<script>
layui.cache.page = 'user';
layui.cache.user = {
  username: '游客'
  ,uid: -1
  ,avatar: '$!{rc.contextPath}/static/res/images/avatar/00.jpg'
  ,experience: 83
  ,sex: '男'
};
layui.config({
  version: "3.0.0"
  ,base: '$!{rc.contextPath}/static/res/mods/'
}).extend({
  fly: 'index'
}).use('fly');

var treeTable;
//table
layui.use(['table','jquery','treeGrid','form'], function(){
	  var form=layui.form;
	  var treeGrid = layui.treeGrid; 
	  var table=layui.table;
	  var layerTips = parent.layer === undefined ? layui.layer : parent.layer; //获取父窗口的layer对象
	  $('#add').click(function(){
		  $('#selectPId').val('');
	  });
	  
	  $('#addPermission').click(function(){
		 var permissionName=$('#permissionName').val();
		 if(!permissionName){
			 layer.msg('权限名称不能为空');
			 return;
		 }
		 var url=$('#url').val();
		 if(!url){
			 layer.msg('权限url地址不能为空');
			 return;
		 }
		 $.ajax({
			 url:'$!{rc.contextPath}/user/permission/add',
			 type:'post',
			 data:{permissionName:permissionName,url:url,pId:$('#selectPId').val()},
			 success:function(res){
				 if(res.code=='200'){
					 layer.msg('新增权限成功');
					 $('#permissionName').val("");
					 $('#url').val("");
					 $('#myModal').modal('hide');
					 treeTable.reload();
				 }else{
					 layer.msg(res.msg);
				 }
			 }
		 }); 
	  });
	  
	    	  
	  treeTable =treeGrid.render({
		  id: 'tab', 
          elem: '#treeTable',
          url:'$!{rc.contextPath}/user/permission/get_permissions',
          cellMinWidth: 100,
          alias: 'changyong',
          treeId:'id',//树形id字段名称
          treeUpId:'pId',//树形父id字段名称
          treeShowName:'name',//以树形式显示的字段
          method: 'post',
          cols: [[
              {field:'id', width:'100', title: 'id'},
              {field:'name', edit:'text',width:'200', title: '权限名'},
              {field:'url', edit:'text',width:'300', title: '权限url'},
              {field:'pId', width:'100', title: 'pId'},
              {field:'ids',width:'250', title: '编辑',templet:function(row){
            	  var add='<a class="layui-btn layui-btn-normal layui-btn-xs" onclick="addSub(\''+row.id+'\')">新增子权限</a>';
    	    	  var t_delete='<a class="layui-btn layui-btn-danger layui-btn-xs" onclick="deleteNode(\''+row.id+'\')">删除</a>';
    	    	  return t_delete+add;
    	      }}
          ]],
          page:false
      });
	  
	  
	  $('#btnAdd').on('click', function() {
			$.get('$!{rc.contextPath}/user/permissionAdd', null, function(form) {
				layer.open({
					type: 1,
					title: '添加权限',
					content: form,
					btn: ['保存', '取消'],
					shade: false,
					offset: ['50px', '20%'],
					area: ['800px', '400px'],
				yes: function(index) {
					//触发表单的提交事件
					$('form.layui-form').find('button[lay-filter=edit]').click();
				},
				full: function(elem) {
					var win = window.top === window.self ? window : parent.window;
					$(win).on('resize', function() {
						var $this = $(this);
						elem.width($this.width()).height($this.height()).css({
							top: 0,
							left: 0
						});
						elem.children('div.layui-layer-content').height($this.height() - 95);
					});
				},
				success: function(layero, index) {
					//弹出窗口成功后渲染表单
					var form = layui.form;
					form.render();
					form.on('submit(edit)', function(data) {
						console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
						console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
						console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
						 $.ajax({
							 url:'$!{rc.contextPath}/user/permission/add',
							 type:'post',
							 data:data.field,
							 success:function(res){
								 if(res.code=='200'){
									 layer.msg('新增权限成功');
									 $('#permissionName').val("");
									 $('#url').val("");
									 $('#myModal').modal('hide');
									 treeTable.reload();
								 }else{
									 layer.msg(res.msg);
								 }
							 }
						 });
						
						//调用父窗口的layer对象
						/*layerTips.open({
							title: '这里面是表单的信息',
							type: 1,
							content: JSON.stringify(data.field),
							area: ['500px', '300px'],
							btn: ['关闭并刷新', '关闭'],
							yes: function(index, layero) {
								layerTips.msg('你点击了关闭并刷新');
								layerTips.close(index);
								location.reload(); //刷新
							}

						});*/
						//这里可以写ajax方法提交表单
						return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。									
					});
					//console.log(layero, index);
				},
				end: function() {
					addBoxIndex = -1;
				}
				});
			});
		});
});

function deleteNode(id){
	 $.ajax({
		 url:'$!{rc.contextPath}/user/permission/delete',
		 type:'post',
		 data:{permissionId:id},
		 success:function(res){
			 if(res.code=='200'){
				 layer.msg('删除权限成功');
				 treeTable.reload();
			 }else{
				 layer.msg(res.msg);
			 }
		 }
	 }); 
	
}

function addSub(pId){
	$('#selectPId').val(pId);
	$('#myModal').modal('show');
}
</script>
</body>
</html>